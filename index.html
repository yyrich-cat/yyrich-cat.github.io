<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐播放器</title>
    <style>
        body {
            background-repeat: no-repeat;
            transition-duration: 1.5s;
        }
        .stand {
            height: 2px;
            background-image: linear-gradient(to right, black, black);
            background-repeat: no-repeat;
            background-size: 0% 100%;
            transition-duration: 500ms;
            transition-property: background-size;
            background-position-x: left;
        }
        .start {
            transition-duration: 7500ms;
            transition-delay: 2000ms;
            background-size: 100% 100%;
            background-position-x: right;
        }
        .hand {
            cursor: pointer;
        }
        .controls {
            height: 50px;
            background-image: linear-gradient(to right, #FF00FF, #FF00FF);
            background-repeat: no-repeat;
            background-size: 0 100%;
            opacity: .5;
        }
        .fakeprogress {
            width: 2px;
            height: 100%;
            background-color: black;
            display: none;
        }
    </style>
</head>
<body>
    <div class="stand" id="timeout"></div>
    <div class="wrapper">
        <canvas width="1024"><span>抱歉，您的浏览器不支持 canvas 元素</span></canvas>
    </div>
    <div class="controls hand" id="ctrl">
        <div class="fakeprogress"></div>
    </div>
    <audio></audio>
    <form>
        <input type="text" name="source" id="audioAdress">
        <input type="submit" value="确定" id="button">
    </form>
    <script>
        const canvasEle = document.getElementsByTagName("canvas")[0];
        const audioEle = document.getElementsByTagName("audio")[0];
        const canvas = canvasEle.getContext('2d');
        let analyser;
        let dataArray;
        function init() {
            init = function () {
                // 什么也不做.
            };
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaElementSource(audioEle);
            analyser = audioCtx.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            draw();
        }
        function makeColor(params) {
            let str = "#";
            for (let i = 0; i < 3; i++) {
                let r = params[i].toString(16);
                if (r.length < 2) {
                    r = '0' + r;
                }
                str += r;
            }
            return str;
        }
        function draw(){
            requestAnimationFrame(draw);
            const {width,height} = canvasEle;
            canvas.clearRect(0,0,width,height);
            analyser.getByteFrequencyData(dataArray);
            const length = dataArray.length;
            const barWidth = width / length;
            let colorData = new Uint8Array(3);
            for (let i = 0; i < length; i++) {
                colorData[0] = 255;
                colorData[1] = dataArray[i] / 2;
                colorData[2] = 255 - dataArray[i];
                canvas.fillStyle = makeColor(colorData);
                const barHeight = (dataArray[i] / 255) * height;
                const x = i * barWidth;
                const y = height - barHeight;
                canvas.fillRect(width - x,0,barWidth,barHeight);
            }
            myPlayer.updateProgressBar();
        }
        function setAudioSrc() {
            let ele = document.getElementById('audioAdress');
            let str = ele.value;
            audioEle.src = str;
            return false;
        }
        document.getElementById('button').onclick = setAudioSrc;
        audioEle.crossOrigin = 'anonymous';
        audioEle.src = "./res/丁当 - 猜不透.mp3"
        audioEle.onplay = function () {
            init();
        };

        function callback(e) {
            console.log(e);
            console.log(e.g);
            console.log(e.g == undefined);
            let ele = document.getElementById(e.q);
            document.body.removeChild(ele);
        }
        function jQuery11020013996247948836915_1683017243859(params) {
            callback(params);
        }
        function ask(str) {
            let ele = document.createElement('script');
            ele.src = 'https://www.baidu.com/sugrec?pre=1&p=3&ie=utf-8&json=1&prod=pc&from=pc_web&wd='+str+'&cb=jQuery11020013996247948836915_1683017243859';
            ele.id = str;
            document.body.appendChild(ele);
        }
        document.body.onresize = function () {
            canvasWidthReset();
        }
        function canvasWidthReset() {
            canvasEle.width = parseInt(getComputedStyle(document.querySelector('.wrapper')).width);
        }
        canvasWidthReset();
        
        
        
        const cgetImg = (function () {
            const img = new Image();
            img.onload = function () {
                document.querySelector("#timeout").classList.add("start");
                setTimeout(() => {
                    document.querySelector("#timeout").classList.remove("start")
                    setTimeout(() => {
                        cgetImg();
                    }, 500);
                }, 9500);
                document.body.style.backgroundImage = "url('"+img.src+"')";
            }
            let num = 0;
            return function () {
                img.src = "https://picsum.photos/"+window.innerWidth+"/"+window.innerHeight+"?r="+num++;
            }
        })();
        
        cgetImg();
        audioEle.src = 'https://webfs.ali.kugou.com/202305051733/91d8c711764306b85a4f1a4521e3d69b/KGTX/CLTX003/a7e08b19c6203260305f2800dbc2574a.mp3';

        
        

        class MyPlayer {
            constructor () {

            }
            updateProgressBar () {
                this.controls_element.style.backgroundSize = this.getProgress()*100+"% 100%";
            }
            getProgress () {
                return this.audio_element.currentTime/audioEle.duration;
            }
            init () {
                this.controls_element.onmouseup = (function (something) {
                    return function (e) {
                        something.isMouseDown = false;
                        something.fakeprogress_ele.style.display = 'none';
                        if (something.mouseDownX == e.x && something.mouseDownY == e.y) {
                            audioEle.paused ? audioEle.play() : audioEle.pause();
                        }else{
                            let a = parseInt(getComputedStyle(something.fakeprogress_ele).marginLeft);
                            a = a / something.controls_element.clientWidth;
                            a = a * audioEle.duration;
                            audioEle.currentTime = a;
                        }
                    }
                })(this)
                this.controls_element.onmousedown = (function (something) {
                    return function (e) {
                        (function (e) {
                            this.isMouseDown = true;
                            this.mouseDownX = e.x;
                            this.mouseDownY = e.y;
                            let style = this.fakeprogress_ele.style;
                            style.display = 'block';
                            style.marginLeft = this.marginLeft = this.getProgress()*this.controls_element.clientWidth+'px';
                        }).call(something, e)
                    }
                })(this);
                this.controls_element.onmousemove = (function (something) {
                    return function (e) {
                        (function (e) {
                            if (this.isMouseDown) {
                                let x = e.x - this.mouseDownX;
                                let ele = this.fakeprogress_ele;
                                let a = parseInt(this.marginLeft) + x;
                                a = a < this.controls_element.clientWidth && a > 0 ? a : a < 0 ? 0 : this.controls_element.clientWidth;
                                ele.style.marginLeft = a +'px';
                            }
                        }).apply(something, [e])
                    }
                })(this)
            }
            audio_element = document.getElementsByTagName("audio")[0];
            controls_element = document.getElementById("ctrl");
            fakeprogress_ele = document.getElementsByClassName('fakeprogress')[0];
            
            isMouseDown;
            mouseDownX;
            mouseDownY;
            marginLeft;
        }
        
        let myPlayer = new MyPlayer();
        myPlayer.init();

        
        
    </script>
</body>
</html>