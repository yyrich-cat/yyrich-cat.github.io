<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐播放器</title>
    <style>
        body {
            background-repeat: no-repeat;
            transition-duration: 1.5s;
        }
        .stand {
            height: 2px;
            background-image: linear-gradient(to right, black, black);
            background-repeat: no-repeat;
            background-size: 0% 100%;
            transition-duration: 500ms;
            transition-property: background-size;
            background-position-x: left;
        }
        .start {
            transition-duration: 7500ms;
            transition-delay: 2000ms;
            background-size: 100% 100%;
            background-position-x: right;
        }
        .hand {
            cursor: pointer;
        }
        .controls {
            height: 50px;
            background-image: linear-gradient(to right, #FF00FF, #FF00FF);
            background-repeat: no-repeat;
            background-size: 0 100%;
            opacity: .5;
        }
        .fakeprogress {
            width: 2px;
            height: 100%;
            background-color: black;
            display: none;
        }
    </style>
</head>
<body>
    <div class="stand" id="timeout"></div>
    <div class="wrapper">
        <canvas width="1024">抱歉，您的浏览器不支持 canvas 元素</canvas>
    </div>
    <div class="controls hand" id="ctrl">
        <div class="fakeprogress"></div>
    </div>
    <audio controls></audio>
    <form>
        <input type="text" name="source" id="audioAdress">
        <input type="submit" value="确定" id="button">
    </form>
    <script>
        const canvasEle = document.getElementsByTagName("canvas")[0];
        const audioEle = document.getElementsByTagName("audio")[0];
        const canvas = canvasEle.getContext('2d');
        let analyser;
        let dataArray;
        function init() {
            init = function () {
                // 什么也不做.
            };
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaElementSource(audioEle);
            analyser = audioCtx.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            draw();
        }
        function makeColor(params) {
            let str = "#";
            for (let i = 0; i < 3; i++) {
                let r = params[i].toString(16);
                if (r.length < 2) {
                    r = '0' + r;
                }
                str += r;
            }
            return str;
        }
        function draw(){
            requestAnimationFrame(draw);
            const {width,height} = canvasEle;
            canvas.clearRect(0,0,width,height);
            analyser.getByteFrequencyData(dataArray);
            const length = dataArray.length;
            const barWidth = width / length;
            let colorData = new Uint8Array(3);
            for (let i = 0; i < length; i++) {
                colorData[0] = 255;
                colorData[1] = dataArray[i] / 2;
                colorData[2] = 255 - dataArray[i];
                canvas.fillStyle = makeColor(colorData);
                const barHeight = (dataArray[i] / 255) * height;
                const x = i * barWidth;
                const y = height - barHeight;
                canvas.fillRect(width - x,0,barWidth,barHeight);
            }
            updateProgressBar();
        }
        function setAudioSrc() {
            let ele = document.getElementById('audioAdress');
            let str = ele.value;
            audioEle.src = str;
            return false;
        }
        document.getElementById('button').onclick = setAudioSrc;
        audioEle.crossOrigin = 'anonymous';
        audioEle.src = "./res/丁当 - 猜不透.mp3"
        audioEle.onplay = function () {
            init();
        };

        function callback(e) {
            console.log(e);
            console.log(e.g);
            console.log(e.g == undefined);
            let ele = document.getElementById(e.q);
            document.body.removeChild(ele);
        }
        function jQuery11020013996247948836915_1683017243859(params) {
            callback(params);
        }
        function ask(str) {
            let ele = document.createElement('script');
            ele.src = 'https://www.baidu.com/sugrec?pre=1&p=3&ie=utf-8&json=1&prod=pc&from=pc_web&wd='+str+'&cb=jQuery11020013996247948836915_1683017243859';
            ele.id = str;
            document.body.appendChild(ele);
        }
        document.body.onresize = function () {
            canvasWidthReset();
        }
        function canvasWidthReset() {
            canvasEle.width = parseInt(getComputedStyle(_('.wrapper')).width);
        }
        canvasWidthReset();
        function _(selectors) {
            return document.querySelector(selectors);
        }
        const img = new Image();
        img.onload = function () {
            _('#timeout').classList.add("start");
            setTimeout(() => {
                _('#timeout').classList.remove("start")
                setTimeout(() => {
                    cgetImg();
                }, 500);
            }, 9500);
            document.body.style.backgroundImage = "url('"+img.src+"')";
        }
        
        const cgetImg = function () {
            let num = 0;
            return function () {
                img.src = "https://picsum.photos/"+window.innerWidth+"/"+window.innerHeight+"?r="+num++;
            }
        }();
        
        
        audioEle.src = 'http://m701.music.126.net/20230505091639/37d5bcef459494fcfdd8700e354ec579/jdymusic/obj/wo3DlMOGwrbDjj7DisKw/14096662709/a252/56b2/45b2/8ca6a0ca473d2ab094e1cf6ea7449725.mp3';
        cgetImg();
        function getProgress() {
            return audioEle.currentTime/audioEle.duration;
        }
        function updateProgressBar() {
            _('#ctrl').style.backgroundSize = getProgress()*100+"% 100%";
        }
        
        let isMouseDown;
        let mouseDownX;
        let mouseDownY;
        let marginLeft;
        _("#ctrl").onmouseup = function (e) {
            isMouseDown = false;
            _('.fakeprogress').style.display = 'none';
            if (mouseDownX == e.x && mouseDownY == e.y) {
                audioEle.paused ? audioEle.play() : audioEle.pause();
            }else{
                let a = parseInt(getComputedStyle(_('.fakeprogress')).marginLeft);
                a = a / _('#ctrl').clientWidth;
                a = a * audioEle.duration;
                audioEle.currentTime = a;
            }
        }
        _("#ctrl").onmousedown = function (e) {
            isMouseDown = true;
            mouseDownX = e.x;
            mouseDownY = e.y;
            let style = _('.fakeprogress').style;
            style.display = 'block';
            style.marginLeft = marginLeft = getProgress()*_('#ctrl').clientWidth+'px';
        }
        _("#ctrl").onmousemove = function (e) {
            if (isMouseDown) {
                let x = e.x - mouseDownX;
                let ele = _('.fakeprogress');
                let a = parseInt(marginLeft) + x;
                a = a < _('#ctrl').clientWidth && a > 0 ? a : a < 0 ? 0 : _('#ctrl').clientWidth;
                ele.style.marginLeft = a +'px';
            }
        }
    </script>
</body>
</html>